<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="main">
  <BehaviorTree ID="Attach">
    <Sequence>
      <BehaviorTreeAction name="MoveJ"
                          action_name="bt_action_service"
                          robot_position="gripper_location"/>
      <BehaviorTreeAction name="connect_robotiq_gripper"
                          action_name="bt_action_service"
                          robot_position=""/>
      <BehaviorTreeAction name="MoveL"
                          action_name="bt_action_service"
                          robot_position="out_of_trail"/>
      <BehaviorTreeAction name="MoveL"
                          action_name="bt_action_service"
                          robot_position="up_position"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="OpenCloseGripper">
    <Sequence>
      <BehaviorTreeAction name="OpenRoboticGripper"
                          action_name=""
                          robot_position=""
                          _failureIf="collide_with_box(RO);"/>
      <BehaviorTreeAction name="CloseRoboticGripper"
                          action_name=""
                          robot_position=""
                          _failureIf="operator_hand_in_way(OP);no_tool_gripped(RK)"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="main">
    <Fallback>
      <Sequence>
        <ScriptCondition name="GripperAttached"
                         code=""
                         _description="Checking if the gripper is attached"/>
        <SubTree ID="Attach"
                 _autoremap="false"/>
      </Sequence>
      <Sequence>
        <BehaviorTreeAction name="MoveL"
                            action_name="bt_action_service"
                            robot_position="tool_position"/>
        <BehaviorTreeAction name="MoveJ"
                            action_name="bt_action_service"
                            robot_position="tool_position"/>
        <SubTree ID="pick"/>
        <BehaviorTreeAction name="MoveJ"
                            action_name="bt_action_service"
                            robot_position="out_of_tool_box"/>
        <BehaviorTreeAction name="MoveL"
                            action_name="bt_action_service"
                            robot_position="up_position"/>
        <BehaviorTreeAction name="MoveL"
                            action_name="bt_action_service"
                            robot_position="target_box"/>
        <BehaviorTreeAction name="MoveJ"
                            action_name="bt_action_service"
                            robot_position="target_box"/>
        <BehaviorTreeAction name="MoveJ"
                            action_name="bt_action_service"
                            robot_position="out_of_tool_box"/>
        <BehaviorTreeAction name="MoveL"
                            action_name="bt_action_service"
                            robot_position="up_position"/>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="pick">
    <Sequence name="place">
      <BehaviorTreeAction name="MoveToPose"
                          action_name=""
                          robot_position=""
                          _failureIf="wrong_pos(RO);operator_on_the_way(OP)"/>
      <SubTree ID="OpenCloseGripper"/>
      <BehaviorTreeAction name="MoveOut"
                          action_name=""
                          robot_position=""
                          _failureIf="Operator_on_the_way(OP);tool_dropped(RK)"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="BehaviorTreeAction"
            editable="true">
      <input_port name="action_name"/>
      <input_port name="robot_position"/>
    </Action>
  </TreeNodesModel>

</root>
