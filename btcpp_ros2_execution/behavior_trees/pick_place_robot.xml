<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="main">
  <BehaviorTree ID="Attach">
    <Sequence>
      <BehaviorTreeAction name="MoveJ"
                          action_name="bt_action_service"
                          command=""/>
      <BehaviorTreeAction name="connect_robotiq_gripper"
                          action_name="bt_action_service"
                          command=""/>
      <BehaviorTreeAction name="MoveL"
                          action_name="bt_action_service"
                          command=""/>
      <BehaviorTreeAction name="MoveL"
                          action_name="bt_action_service"
                          command=""/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="OpenCloseGripper">
    <Sequence>
      <BehaviorTreeAction name="OpenRoboticGripper"
                          command=""
                          _failureIf="collide_with_box(RO);"/>
      <BehaviorTreeAction name="CloseRoboticGripper"
                          command=""
                          _failureIf="operator_hand_in_way(OP);no_tool_gripped(RK)"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="main">
    <Fallback>
      <Sequence>
        <ScriptCondition name="GripperAttached"
                         code=""
                         _description="Checking if the gripper is attached"/>
        <SubTree ID="Attach"
                 _autoremap="false"/>
      </Sequence>
      <Sequence>
        <SubTree ID="pick"/>
      </Sequence>
      <Fallback>
        <RetryUntilSuccessful num_attempts="">
          <BehaviorTreeAction name="pick"
                              action_name="bt_action_service"
                              command="pick"
                              _failureIf="robot_collide;no_part_picked;picked_and_dropped;"/>
        </RetryUntilSuccessful>
        <BehaviorTreeAction name="notify_operator"
                            action_name="bt_action_service"
                            command="notify_operator"/>
      </Fallback>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="pick">
    <Sequence name="pick">
      <BehaviorTreeAction name="MoveToPose"
                          command="robot_movej_A"
                          _failureIf="wrong_pos(RO);operator_on_the_way(OP)"/>
      <SubTree ID="OpenCloseGripper"
               _autoremap="false"/>
      <BehaviorTreeAction action_name="bt_action_service"
                          command="pick"/>
      <BehaviorTreeAction name="MoveOut"
                          command="robot_movej_B"
                          _failureIf="Operator_on_the_way(OP);tool_dropped(RK)"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="BehaviorTreeAction"
            editable="true">
      <input_port name="action_name"
                  default="bt_action_service"/>
      <input_port name="command"/>
    </Action>
  </TreeNodesModel>

</root>
